{% extends 'front_office/base.html.twig' %}

{% block title %}Hello PostGroupController!{% endblock %}

{% block main %}
<main class="blog-mp">  
    <div class="main-section">
        <div class="container">
            <div class="row">
                <div class="col-lg-2 col-md-3">                              
                   
                </div>
                <div class="col-lg-9 col-md-8">
                    <div class="blog-post-comment">
                        <div class="blog-comments">
                            <div class="blog-comment-title">
                                <h2>FOUND IT HERE</h2>
                            </div>
                            
                            <div class="blog-main-img">
                                <img src="{{ asset('uploads/' ~ sponsoringImage) }}" style="max-width: 960px; max-height: 330px;" alt="">
                            </div>
                            
                            
                            {{ form_start(f, {'attr': {'novalidate': 'novalidate', 'class': 'form-group'}}) }}
                            <div class="blog-post-comment">
                                <div class="blog-post-bg">
                                    <div class="commntr-dp">
                                        {% if app.user.photo is defined and app.user.photo %}
                                            <img class="user-photo" src="{{ asset('uploads/' ~ app.user.photo) }}" alt="User Photo">
                                        {% else %}
                                            <img class="user-photo" src="{{ asset('front_office/images/default-user.png') }}" alt="Default User">
                                        {% endif %}
                                    </div>
                                    {{ form_widget(f.contenu) }}
                                    {{ form_widget(f.public, {'attr': {'class': 'blog-post-btn col-sm-2'}}) }}
                                </div>
                            </div>
                            {{ form_end(f) }}

                            {% for post in showpost %}
                                <div class="blog-comntd-bg">
                                    {% if app.user == post.user %}
                                        <div class="dropdown edit-delete-dropdown" style="padding-left: 933px;">
                                            <a class="ellipsis-btn dropdown-toggle-no-caret" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </a>
                                            <ul class="dropdown-menu" aria-labelledby="dropdownMenuLink">
                                                <li><a class="dropdown-item" href="{{ path('editpost', {'id': post.id}) }}" onclick="return confirm('√ätes-vous s√ªr de vouloir √©diter ce post?')">Edit</a></li>
                                                <li><a class="dropdown-item" href="{{ path('deletepost', {'id': post.id}) }}" onclick="return confirm('√ätes-vous s√ªr de vouloir supprimer ce post?')">Delete</a></li>
                                            </ul>
                                        </div>
                                    {% endif %}
                                    <div class="bcmnt-dt">
                                        <div class="blog-usr-dt">
                                            {% if post.user.photo is defined and post.user.photo %}
                                                <img class="user-photo" src="{{ asset('uploads/' ~ post.user.photo) }}" alt="User Photo">
                                            {% else %}
                                                <img class="user-photo" src="{{ asset('front_office/images/default-user.png') }}" alt="Default User">
                                            {% endif %}
                                            <a href="user_profile.html"><h4>{{ post.user.getUsername() }}</h4></a>
                                            <h6><span style="font-size: x-small; padding-left: 75px;">{{ post.date | date('Y-m-d') }}</span></h6>
                                        </div>
                                        <p>{{ post.contenu }}</p>
                                    </div>
                                    <div class="blog-post-reply">
                                        <div class="breply-dp1">
                                            {% if app.user.photo %}
                                                <img class="user-photo" src="{{ asset('uploads/' ~ app.user.photo) }}" alt="User Photo">
                                            {% else %}
                                                <img class="user-photo" src="{{ asset('front_office/images/default-user.png') }}" alt="Default User">
                                            {% endif %}
                                        </div>
                                        <form method="POST" action="{{ path('commentaire_add', {'id': post.id}) }}">
                                            <input class="breply-post" type="text" name="contenu" placeholder="Write a reply">
                                            <button class="breply-post-btn" type="submit">Reply</button>
                                        </form>
                                    </div>
                                    {% for commentaire in post.postcommentaires %}
                                        <div class="blog-post-reply">
                                            <div class="breply-dp1">
                                                {% if commentaire.user.photo is defined and commentaire.user.photo %}
                                                    <img class="user-photo" src="{{ asset('uploads/' ~ commentaire.user.photo) }}" alt="User Photo">
                                                {% else %}
                                                    <img class="user-photo" src="{{ asset('front_office/images/default-user.png') }}" alt="Default User">
                                                {% endif %}
                                            </div>
                                            <p>{{ commentaire.getCommentaire() }}</p>
                                            <!-- Bouton de suppression -->
                                           {% if app.user == commentaire.user %}
                                           <div class="comment-links"  >
                                               <a class="btn btn-link  " href="{{ path('commentaire_edit',  {'id': post.id, 'commentId': commentaire.id}) }}" onclick="return confirm('√ätes-vous s√ªr de vouloir √©diter ce commentaire?')">‚úèÔ∏è</a>
                                               <a class="btn btn-link" href="{{ path('commentaire_delete',  {'id': post.id, 'commentId': commentaire.id}) }}" onclick="return confirm('√ätes-vous s√ªr de vouloir supprimer ce commentaire?')">üóëÔ∏è</a>
                                           </div>
                                           {% endif %}
                                             
                                            <div class="comment-actions"style="padding: 0px 0px 0px 750px;">
                                                {% if commentaire.isLikedByUser(app.user) %}
                                                    <button class="like-button breply-post-btn col-sm-9 " data-comment-id="{{ commentaire.id }}" onclick="dislikeComment(this.dataset.commentId)">üëé </button>
                                                {% else %}
                                                    <button class="like-button breply-post-btn col-sm-9 "  data-comment-id="{{ commentaire.id }}" onclick="likeComment(this.dataset.commentId)">üëç </button>
                                                {% endif %}
                                                
                                            </div>
                                            <span class="like-count" data-comment-id="{{ commentaire.id }}">{{ commentaire.likes }}</span> Likes
                                           
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>              
        </div>
    </div>
</main>
<style>
    .comment-links {
        margin-right: 500px; /* Adjust the value as needed */
    }
    /* Default style for the like button */
    .like-button {
      font-size: 20px;
      transition: color 0.3s ease;
    }

    /* Style for the like button when active */
    .like-button.active {
      color: yellow; /* Change the color to yellow when active */
    }
    .heart-icon {
            font-size: 20px;
            color: rgb(200, 30, 30); /* Couleur du c≈ìur vide */
            transition: color 0.3s ease;
        }
        .heart-icon.filled {
            color: rgb(216, 150, 150); /* Couleur du c≈ìur plein */
        }
</style>

<script>
    // Gestionnaire d'√©v√©nements pour le clic sur le bouton "J'aime"
    document.querySelectorAll('.like-button').forEach(function(button) {
        button.addEventListener('click', function() {
            var commentId = this.getAttribute('data-comment-id');

            // Envoyer une requ√™te AJAX au serveur pour "aimer" le commentaire
            fetch('/like-comment/' + commentId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ isLiked: true }) // Envoyer le statut "isLiked" comme true
            })
            .then(function(response) {
                // Mettre √† jour l'affichage du nombre de likes si la requ√™te est r√©ussie
                if (response.ok) {
                    return response.json();
                }
                throw new Error('√âchec de la requ√™te.');
            })
            .then(function(data) {
                // Mettre √† jour le nombre de likes affich√©
                var likeCountElement = document.querySelector('.like-count[data-comment-id="' + commentId + '"]');
                likeCountElement.textContent = data.likes;
            })
            .catch(function(error) {
                console.error('Erreur :', error);
            });
        });
    });
    function dislikeComment(commentId) {
        fetch('/dislike-comment/' + commentId, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            // Ajouter tout autre en-t√™te n√©cessaire ou jetons CSRF
        })
        .then(response => {
            if (!response.ok) throw new Error('La r√©ponse du r√©seau n\'est pas valide.');
            return response.json();
        })
        .then(data => {
            // Mettre √† jour l'interface utilisateur pour refl√©ter le "dislike" du commentaire
            const button = document.querySelector(`button[data-comment-id='${commentId}']`);
            button.innerText = 'Like'; // Change le texte du bouton de "Dislike" √† "Like"
            button.setAttribute('onclick', `likeComment(${commentId})`); // Change l'attribut onclick pour appeler la fonction likeComment
            const likedMessage = button.previousElementSibling; // R√©cup√®re l'√©l√©ment pr√©c√©dent du bouton (le message "Vous avez aim√© ce commentaire.")
            likedMessage.remove(); // Supprime le message "Vous avez aim√© ce commentaire."
            // Mettre √† jour le nombre de likes si n√©cessaire
            const likeCount = document.querySelector(`.like-count[data-comment-id='${commentId}']`);
            likeCount.innerText = data.likes;
        })
        .catch(error => {
            console.error('Un probl√®me est survenu lors de votre op√©ration fetch :', error);
        });
    }
    
</script>

{% endblock %}
